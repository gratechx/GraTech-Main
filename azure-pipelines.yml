# Azure Pipeline - GraTech Backend API
# Automated CI/CD for Container Apps

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'api/**'
      - 'Dockerfile'
      - 'requirements.txt'

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerRegistryServiceConnection: 'gratech-acr'
  imageRepository: 'gratech-api'
  containerRegistry: 'gratechacr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  
  # Azure Container Apps
  resourceGroup: 'rg-gratech-prod'
  containerAppName: 'gratech-api'
  location: 'uaenorth'

stages:
  - stage: Build
    displayName: 'Build and Push Docker Image'
    jobs:
      - job: Build
        displayName: 'Build Job'
        steps:
          - task: Docker@2
            displayName: 'Build and push image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Azure Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy Job'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Update Container App'
                  inputs:
                    azureSubscription: 'gratech-azure-subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --image $(containerRegistry)/$(imageRepository):$(tag) \
                        --set-env-vars \
                          OPENAI_API_KEY=secretref:openai-key \
                          GEMINI_API_KEY=secretref:gemini-key \
                          DEEPSEEK_API_KEY=secretref:deepseek-key

                - task: AzureCLI@2
                  displayName: 'Health Check'
                  inputs:
                    azureSubscription: 'gratech-azure-subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Waiting for deployment..."
                      sleep 30
                      
                      # Get Container App URL
                      APP_URL=$(az containerapp show \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query properties.configuration.ingress.fqdn \
                        -o tsv)
                      
                      # Health check
                      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$APP_URL/health)
                      
                      if [ $HTTP_CODE -eq 200 ]; then
                        echo "✅ Deployment successful! Health check passed."
                        echo "URL: https://$APP_URL"
                      else
                        echo "❌ Health check failed with code: $HTTP_CODE"
                        exit 1
                      fi
